<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METIS | Cloud Intelligence System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', -apple-system, sans-serif; background-color: #ffffff; color: #171a20; letter-spacing: -0.01em; }
        ::-webkit-scrollbar { width: 3px; height: 3px; }
        ::-webkit-scrollbar-thumb { background: #e2e2e2; border-radius: 10px; }
        .sidebar-brand { transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-brand.active { border-left-color: #171a20; background-color: #f9f9f9; font-weight: 600; }
        .dealer-tab { transition: all 0.3s; border-bottom: 2px solid transparent; white-space: nowrap; }
        .dealer-tab.active { border-bottom-color: #171a20; color: #000; font-weight: 600; }
        .branch-card { border: 1px solid #f2f2f2; transition: all 0.2s; background: #fff; border-radius: 4px; height: 210px; display: flex; flex-direction: column; justify-content: space-between; }
        .branch-card:hover { border-color: #171a20; box-shadow: 0 12px 24px rgba(0,0,0,0.04); }
        input, textarea { border: 1px solid #eeeeee; border-radius: 4px; padding: 12px; width: 100%; background-color: #fbfbfb; font-size: 14px; }
        input:focus, textarea:focus { outline: none; border-color: #171a20; background-color: #fff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-white">

    <aside class="w-64 border-r border-gray-100 flex flex-col">
        <div class="p-8"><h1 class="text-xl font-bold tracking-tighter italic">METIS</h1><p class="text-[9px] text-gray-400 tracking-widest uppercase mt-1">Strategic Network</p></div>
        <nav class="flex-1 overflow-y-auto px-4 space-y-1 no-scrollbar" id="brand-nav"></nav>
        <div class="p-4 border-t border-gray-50 text-[10px] text-blue-500 text-center uppercase tracking-widest font-bold">Cloud Sync Active</div>
    </aside>

    <main class="flex-1 flex flex-col">
        <header class="pt-10 px-10 border-b border-gray-50">
            <div class="flex justify-between items-end mb-6">
                <div><h2 id="current-brand" class="text-3xl font-semibold tracking-tight uppercase">Mercedes-Benz</h2><p class="text-xs text-gray-400 mt-1 italic">실시간 클라우드 동기화 모드: 모든 기기에서 공유됨</p></div>
                <button onclick="openDealerPanel()" class="text-[11px] font-bold bg-[#171a20] text-white px-6 py-2.5 rounded-full hover:bg-black transition uppercase tracking-widest">딜러사 본사 결정권자</button>
            </div>
            <div class="flex space-x-8 overflow-x-auto no-scrollbar" id="dealer-tabs"></div>
        </header>
        <section class="flex-1 overflow-y-auto p-10 bg-[#fafafa]">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="branch-grid"></div>
        </section>
    </main>

    <!-- [Panel 1] 지점 편집 -->
    <div id="side-panel" class="fixed inset-y-0 right-0 w-[480px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out border-l border-gray-100 overflow-y-auto p-12">
        <div class="flex justify-between items-center mb-10"><span id="panel-dealer-tag" class="text-[10px] font-bold bg-gray-100 px-3 py-1 rounded uppercase tracking-widest font-mono">DEALER</span><button onclick="closePanel()" class="text-3xl font-light">&times;</button></div>
        <h3 id="panel-branch-title" class="text-3xl font-semibold mb-10 tracking-tight italic">지점명</h3>
        <div class="space-y-8">
            <div><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Branch Manager</label><input type="text" id="in-mgr"></div>
            <div><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Direct Contact</label><input type="text" id="in-tel"></div>
            <div><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Strategy Log</label><textarea id="in-notes" rows="10"></textarea></div>
            <button id="btn-save-branch" class="w-full bg-[#171a20] text-white py-5 rounded-md font-semibold text-sm hover:bg-black transition shadow-xl uppercase">Cloud Sync & Save</button>
        </div>
    </div>

    <!-- [Panel 2] 딜러사 본사 정보 -->
    <div id="dealer-panel" class="fixed inset-y-0 right-0 w-[500px] bg-[#f9f9f9] shadow-2xl z-[60] transform translate-x-full transition-transform duration-300 border-l border-gray-200 overflow-y-auto p-12">
        <div class="flex justify-between items-center mb-10"><span class="text-[10px] font-bold bg-black text-white px-3 py-1 rounded uppercase tracking-widest">HQ Executive</span><button onclick="closeDealerPanel()" class="text-3xl font-light">&times;</button></div>
        <h3 id="dealer-panel-title" class="text-3xl font-semibold mb-10 tracking-tight italic text-black">딜러사명</h3>
        <div class="space-y-8 bg-white p-8 rounded-xl border border-gray-100">
            <div><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">CEO</label><input type="text" id="dealer-ceo"></div>
            <div><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Sales Director</label><input type="text" id="dealer-vp"></div>
            <div><label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Strategy Note</label><textarea id="dealer-memo" rows="6"></textarea></div>
            <button id="btn-save-dealer" class="w-full bg-[#171a20] text-white py-5 rounded-md font-semibold text-sm uppercase tracking-widest shadow-xl">Update HQ Cloud Info</button>
        </div>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ⚠️ [중요] Firebase 콘솔에서 복사한 본인의 Config 코드로 교체하세요
        const firebaseConfig = {
            apiKey: "AIzaSyCakAE_wHbzSNsBL7RKDUcouecxsxvdfvQ",
            authDomain: "metis-intelligence2.firebaseapp.com",
            projectId: "metis-intelligence2",
            storageBucket: "metis-intelligence2.firebasestorage.app",
            messagingSenderId: "513399115970",
            appId: "1:513399115970:web:f9504d34f82920d747eb5b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 전역 데이터 저장소 (실시간 업데이트 반영용)
        let CLOUD_DATA = {};
        let DEALER_CLOUD_DATA = {};

        // 브랜드 데이터 구조
        const DATA_MAP = {
            "Mercedes-Benz": { "한성자동차": ["강남본점", "청담", "삼성", "서초", "방배", "분당", "인천", "부산"], "효성자동차": ["강북", "서대문", "안양", "광주"], "KCC오토": ["금천", "영등포", "한남"], "모터원": ["일산", "파주"] },
            "BMW": { "코오롱모터스": ["강남", "삼성", "분당", "광주", "대구"], "도이치모터스": ["성수", "한남", "미사", "수원"], "한독모터스": ["용산", "서초", "방배"], "바바리안모터스": ["송도", "일산"] },
            "Audi": { "고진모터스": ["도산대로", "수원", "천안"], "태안모터스": ["도곡", "방배", "목동"], "코오롱아우토": ["대치", "송파"] },
            "Porsche": { "SSCL": ["대치", "서초", "분당", "인천"], "아우토승": ["용산", "수원"], "세영모빌리티": ["송파", "성수"] },
            "Volvo": { "에이치모터스": ["강남", "서초", "수원"], "아이비모터스": ["광주", "순천"], "아이언모터스": ["부산", "창원"] },
            "Lexus": { "천우모터스": ["용산", "일산"], "D&T": ["강남", "대치"] },
            "Rolls-Royce": { "코오롱모터스": ["청담", "부산"] }, "Lamborghini": { "SQDA모터스": ["삼성"] }, "Ferrari": { "FMK": ["강남", "반포"] }
            // ... (기존 브랜드 리스트 유지)
        };

        let currentBrand = "", currentDealer = "", activeBranchKey = "";

        // 실시간 리스너 연결 (데이터가 바뀌면 즉시 화면 갱신)
        onSnapshot(doc(db, "metis", "branches"), (doc) => {
            if (doc.exists()) { CLOUD_DATA = doc.data(); renderBranches(); }
        });
        onSnapshot(doc(db, "metis", "dealers"), (doc) => {
            if (doc.exists()) { DEALER_CLOUD_DATA = doc.data(); }
        });

        const brandNav = document.getElementById('brand-nav');
        Object.keys(DATA_MAP).forEach((brand, idx) => {
            const btn = document.createElement('button');
            btn.className = "sidebar-brand w-full text-left px-4 py-3 text-[13px] sidebar-item uppercase tracking-tighter";
            btn.innerText = brand;
            btn.onclick = () => selectBrand(brand, btn);
            brandNav.appendChild(btn);
            if(idx === 0) selectBrand(brand, btn);
        });

        function selectBrand(brand, el) {
            currentBrand = brand;
            document.querySelectorAll('.sidebar-brand').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('current-brand').innerText = brand;
            const dealerTabs = document.getElementById('dealer-tabs');
            dealerTabs.innerHTML = "";
            Object.keys(DATA_MAP[brand]).forEach((dealer, idx) => {
                const tab = document.createElement('button');
                tab.className = "dealer-tab pb-4 text-[11px] font-bold uppercase tracking-widest text-gray-400";
                tab.innerText = dealer;
                tab.onclick = () => selectDealer(dealer, tab);
                dealerTabs.appendChild(tab);
                if(idx === 0) selectDealer(dealer, tab);
            });
        }

        function selectDealer(dealer, el) {
            currentDealer = dealer;
            document.querySelectorAll('.dealer-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderBranches();
        }

        function renderBranches() {
            const grid = document.getElementById('branch-grid');
            grid.innerHTML = "";
            if (!DATA_MAP[currentBrand] || !DATA_MAP[currentBrand][currentDealer]) return;
            
            DATA_MAP[currentBrand][currentDealer].forEach(branch => {
                const key = `${currentBrand}_${currentDealer}_${branch}`;
                const savedData = CLOUD_DATA[key] || { mgr: "미기입", tel: "미기입" };
                
                const card = document.createElement('div');
                card.className = "branch-card p-8 cursor-pointer";
                card.onclick = () => openPanel(branch);
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[9px] font-bold text-gray-300 tracking-widest uppercase font-mono">${currentDealer}</span>
                            <div class="w-2 h-2 rounded-full ${savedData.mgr !== "미기입" ? 'bg-black' : 'bg-gray-100'}"></div>
                        </div>
                        <h4 class="text-xl font-semibold italic tracking-tighter">${branch}</h4>
                    </div>
                    <div class="space-y-3 pt-4 border-t border-gray-50 text-[10px] uppercase font-bold tracking-widest">
                        <div class="flex justify-between"><span class="text-gray-400">Manager</span><span class="text-black">${savedData.mgr}</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Contact</span><span class="text-blue-600 font-mono tracking-tighter">${savedData.tel}</span></div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 지점 데이터 저장 (Firebase)
        document.getElementById('btn-save-branch').onclick = async () => {
            const mgr = document.getElementById('in-mgr').value || "미기입";
            const tel = document.getElementById('in-tel').value || "미기입";
            const notes = document.getElementById('in-notes').value;
            
            CLOUD_DATA[activeBranchKey] = { mgr, tel, notes };
            await setDoc(doc(db, "metis", "branches"), CLOUD_DATA);
            closePanel();
        };

        // 딜러 본사 데이터 저장 (Firebase)
        document.getElementById('btn-save-dealer').onclick = async () => {
            const key = `${currentBrand}_${currentDealer}`;
            DEALER_CLOUD_DATA[key] = {
                ceo: document.getElementById('dealer-ceo').value,
                vp: document.getElementById('dealer-vp').value,
                memo: document.getElementById('dealer-memo').value
            };
            await setDoc(doc(db, "metis", "dealers"), DEALER_CLOUD_DATA);
            alert("본사 데이터가 클라우드에 실시간 반영되었습니다.");
            closeDealerPanel();
        };

        // 패널 제어 함수들을 모듈 스코프 밖으로 노출
        window.openPanel = (branch) => {
            activeBranchKey = `${currentBrand}_${currentDealer}_${branch}`;
            document.getElementById('panel-dealer-tag').innerText = currentDealer;
            document.getElementById('panel-branch-title').innerText = branch;
            const data = CLOUD_DATA[activeBranchKey] || { mgr: "", tel: "", notes: "" };
            document.getElementById('in-mgr').value = data.mgr === "미기입" ? "" : data.mgr;
            document.getElementById('in-tel').value = data.tel === "미기입" ? "" : data.tel;
            document.getElementById('in-notes').value = data.notes || "";
            document.getElementById('side-panel').classList.remove('translate-x-full');
        };
        window.closePanel = () => { document.getElementById('side-panel').classList.add('translate-x-full'); };
        window.openDealerPanel = () => {
            document.getElementById('dealer-panel-title').innerText = currentDealer;
            const data = DEALER_CLOUD_DATA[`${currentBrand}_${currentDealer}`] || { ceo: "", vp: "", memo: "" };
            document.getElementById('dealer-ceo').value = data.ceo;
            document.getElementById('dealer-vp').value = data.vp;
            document.getElementById('dealer-memo').value = data.memo;
            document.getElementById('dealer-panel').classList.remove('translate-x-full');
        };
        window.closeDealerPanel = () => { document.getElementById('dealer-panel').classList.add('translate-x-full'); };

    </script>
</body>
</html>
